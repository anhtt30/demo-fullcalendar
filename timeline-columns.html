<!DOCTYPE html>
<html>

<head>
  <meta charset='utf-8' />
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.min.js" type="text/javascript"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js" type="text/javascript"></script>
  <script src='../dist/index.global.js'></script>
  <script>

    $(document).ready(function () {

      var calendarEl = document.getElementById('calendar');

      var calendar = new FullCalendar.Calendar(calendarEl, {
        now: '2023-01-07',
        editable: true,
        aspectRatio: 1.8,
        //scrollTime: '00:00',
        headerToolbar: {
          left: 'today prev,next',
          center: 'title',
          right: 'resourceTimelineDay,resourceTimelineThreeDays,timeGridWeek,dayGridMonth'
        },
        initialView: 'resourceTimeline',
        views: {
          resourceTimelineThreeDays: {
            type: 'resourceTimeline',
            duration: { days: 3 },
            buttonText: '3 days'
          }
        },
        resourceOrder: 'sortOrder',
        resourceAreaWidth: '50%',

        resources: [
          { id: '1', title: 'Auditorium A', occupancy: 40, subRoom: 'A1', sortOrder: 0 },
          {
            id: 'a', title: 'Auditorium A', occupancy: 40, subRoom: 'A1', sortOrder: 1, children: [
              { id: 'b', title: 'Auditorium B', occupancy: 40, subRoom: 'B1', eventColor: 'green', sortOrder: 2 },
              { id: 'c', title: 'Auditorium C', occupancy: 40, subRoom: 'C1', eventColor: 'orange', sortOrder: 3 },
              { id: 'd', title: 'Auditorium D', occupancy: 40, subRoom: 'D1', sortOrder: 4 },
              { id: 'd1', title: 'Room D1', occupancy: 10, subRoom: 'D1-A', sortOrder: 5 },
            ]
          },
          {
            id: 'd2', title: 'Room D2', occupancy: 10, subRoom: 'D1-B', sortOrder: 6, children: [
              { id: 'e', title: 'Auditorium E', occupancy: 40, subRoom: 'E1', sortOrder: 7 },
              { id: 'f', title: 'Auditorium F', occupancy: 40, subRoom: 'F1', eventColor: 'red', sortOrder: 8 },
              { id: 'g', title: 'Auditorium G', occupancy: 40, subRoom: 'G1', sortOrder: 9 },
              { id: 'h', title: 'Auditorium H', occupancy: 40, subRoom: 'H1', sortOrder: 10 },
              { id: 'i', title: 'Auditorium I', occupancy: 40, subRoom: 'I1', sortOrder: 11 },
              { id: 'j', title: 'Auditorium J', occupancy: 40, subRoom: 'J1', sortOrder: 12 },
              { id: 'k', title: 'Auditorium K', occupancy: 40, subRoom: 'K1', sortOrder: 13 },
              { id: 'l', title: 'Auditorium L', occupancy: 40, subRoom: 'L1', sortOrder: 14 },
              { id: 'm', title: 'Auditorium M', occupancy: 40, subRoom: 'M1', sortOrder: 15 },
            ]
          },
          {
            id: 'n', title: 'Auditorium N', occupancy: 40, subRoom: 'N1', sortOrder: 16, children: [
              { id: 'o', title: 'Auditorium O', occupancy: 40, subRoom: 'O1', sortOrder: 17 },
              { id: 'p', title: 'Auditorium P', occupancy: 40, subRoom: 'P1', sortOrder: 18 },
              { id: 'q', title: 'Auditorium Q', occupancy: 40, subRoom: 'Q1', sortOrder: 19 },
              { id: 'r', title: 'Auditorium R', occupancy: 40, subRoom: 'R1', sortOrder: 20 },
              { id: 's', title: 'Auditorium S', occupancy: 40, subRoom: 'S1', sortOrder: 21 },
              { id: 't', title: 'Auditorium T', occupancy: 40, subRoom: 'T1', sortOrder: 22 },
              { id: 'u', title: 'Auditorium U', occupancy: 40, subRoom: 'U1', sortOrder: 23 },
              { id: 'v', title: 'Auditorium V', occupancy: 40, subRoom: 'V1', sortOrder: 24 },
              { id: 'w', title: 'Auditorium W', occupancy: 40, subRoom: 'W1', sortOrder: 25 },
              { id: 'x', title: 'Auditorium X', occupancy: 40, subRoom: 'X1', sortOrder: 26 },
              { id: 'y', title: 'Auditorium Y', occupancy: 40, subRoom: 'Y1', sortOrder: 27 },
              { id: 'z', title: 'Auditorium Z', occupancy: 40, subRoom: 'Z1', sortOrder: 28 }
            ]
          },
        ],

        resourceAreaColumns: [
          {
            headerContent: "header 1",
            field: "title",
          },
          {
            headerContent: "header 2",
            field: "occupancy",
          },
          {
            headerContent: "header 3",
            field: "subRoom",
          },
          {
            headerContent: "header 4",
            field: "sortOrder",
          }
        ],

        events: [
          { id: '1', resourceId: 'b', start: '2023-01-07T02:00:00', end: '2023-01-07T07:00:00', title: 'event 1' },
          { id: '2', resourceId: 'c', start: '2023-01-07T05:00:00', end: '2023-01-07T22:00:00', title: 'event 2' },
          { id: '3', resourceId: 'd', start: '2023-01-06', end: '2023-01-08', title: 'event 3' },
          { id: '4', resourceId: 'e', start: '2023-01-07T03:00:00', end: '2023-01-07T08:00:00', title: 'event 4' },
          { id: '5', resourceId: 'f', start: '2023-01-07T00:30:00', end: '2023-01-07T02:30:00', title: 'event 5' }
        ],
        viewDidMount: function (arg) {
          const table = $('.fc-datagrid-body tbody').first();
          const rows = table.find('tr');

          Array.from(rows).slice(0, 6).forEach(row => {
            $(row).attr('data-section','1');
          });

          Array.from(rows).slice(6, 15).forEach(row => {
            $(row).attr('data-section','2');
          });
          let sortableClasses = ['.sortable-row', '.sortable-row-1'];
          // sortableClasses.forEach(sortableClass => {
            let originalItem;
            let draggedGroup;
            let draggedItems;         
            $(".fc-datagrid-body tbody").sortable({

            // items: 'tr:not(:first-child)',
            items: 'tr',
            dropOnEmpty: false,
            //revert: true,

            placeholder: 'ui-state-highlight',

            helper: function (event, ui) {
                // Store the group of rows to drag
                // draggedGroup = ui.data('group');
                // draggedItems = ui.closest('tbody').find(`tr[data-group="${draggedGroup}"]`);
                draggedGroup = ui.data('section');


                draggedItems = ui.closest('tbody').find(`tr[data-section="${draggedGroup}"]`);

                // Create a custom helper
                const helper = $('<div><ul></ul></div>');
                const tbody = helper.find('ul');
                // draggedItems.clone().appendTo(helper);
                // Adjust width of the helper columns to match the original table
                draggedItems.each(function (index, element) {
                  const originalTds = $(element).children().eq(0);
                  originalTds.each(function(index, ele) {
                    $('<li>').append($(ele).text()).appendTo(tbody);
                  });
                  // const clonedTds = tbody.children().eq(index).children();
                  // clonedTds.each(function (tdIndex, clonedTd) {
                  //   $(clonedTd).width($(originalTds[tdIndex]).width());
                  // });
                });

                
                return helper;
              },

            start: function (G, ui) {
              draggedGroup = ui.item.data('section');
              //draggedItems = ui.item.closest('tbody').find(`tr[data-section="${draggedGroup}"]`);
              //console.log(draggedItems);
              //draggedItems.addClass('dragging');
              ui.item.data('originalSection', ui.item.data('section'));
              ui.item.data('originalIndex', ui.item.index());
              // Hide the dragged rows initially
              //draggedItems.css('visibility', 'hidden');
            },

            sort: function (event, ui) {
              let originalSection = ui.item.data('section');
              let newSection = ui.placeholder.prev().data('section') || ui.placeholder.next().data('section');

              if (!newSection) {
                newSection = ui.item.data('section');
              }

              if (originalSection !== newSection) {
                ui.placeholder.addClass('disabled');
              } else {
                //draggedItems.css('visibility', 'visible');
                ui.placeholder.html(ui.item.html());
                ui.placeholder.removeClass('disabled');
                // Show the dragged rows while sorting
                
              }
              
            },
  
            stop: function (event, ui) {
              // After drag stop, enforce section rules
              let originalSection = ui.item.data('section');
              let originalIndex = ui.item.data('originalIndex');
              let newSection = ui.item.prev().data('section') || ui.item.next().data('section');

              if (!newSection) {
                newSection = ui.item.data('section');
              }

              if (originalSection !== newSection) {
                // Revert to the original position if moved to a different section
                let originalItem = $('.fc-datagrid-body tr').eq(originalIndex);
                if(originalIndex > ui.item.index()) {
                  let currentItem =  ui.item.detach();
                  originalItem.after(currentItem); // Move the item back to its original position
                } else if (originalIndex < ui.item.index()) {
                  let currentItem =  ui.item.detach();
                  originalItem.before(currentItem); // Move the item back to its original position
                }
              } else {
                //var sortedIDs = $(this).sortable("toArray", { attribute: "data-resource-id" });
                var sortedIDs = $(this).children('tr').map(function () {
                  return $(this).find('td[data-resource-id]').data('resource-id');
                }).get();
                // Update resource order in FullCalendar
                var sortedResources = sortedIDs.map(function (id) {
                  return calendar.getResourceById(id);
                });
                sortedResources.forEach(function (resource, index) {
                  resource.setExtendedProp('sortOrder', index);
                });
                //update resource
                //calendar.setOption('resources', sortedResources);
              }
              // Manually trigger a re-render of the resources
              // calendar.render();
            }
      
          });

        // });
          $(".fc-datagrid-body tbody").disableSelection();

          // Add custom group header after rendering
          const tableHeader = calendarEl.querySelector('.fc-datagrid-header thead tr');
          const groupHeader = document.createElement('tr');

          // Create a group header cell that spans 3 columns
          const groupHeaderCell = document.createElement('th');
          groupHeaderCell.setAttribute('colspan', '3');
          groupHeaderCell.className = 'fc-col-group-header';
          groupHeaderCell.innerText = 'Group Header';
          groupHeader.appendChild(groupHeaderCell);

          // Insert the group header row before the column headers
          tableHeader.parentNode.insertBefore(groupHeader, tableHeader);
        }
        
        //  eventContent: function (arg) {
        //  resourceAreaHeaderContent: function (arg) {
        //   return "room";
        //  },

      });

      calendar.render();
    });


  </script>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, Helvetica Neue, Helvetica, sans-serif;
      font-size: 14px;
    }

    #calendar {
      max-width: 1100px;
      margin: 50px auto;
    }

    .ui-state-highlight {
      background-color: #ddd; /* Background color for the placeholder */
      border: 1px dashed #aaa; /* Dashed border to distinguish placeholder */
    }

    .disabled { display: none;} /* Disabled effect */

    .fc-col-group-header {
      text-align: center;
      font-weight: bold;
      background-color: #f8f8f8;
      border-bottom: 1px solid #ddd;
    }
    .fc-col-group {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .fc-datagrid-cell-resizer {
      pointer-events: none;
      cursor: default;
    }
  </style>
</head>

<body>

  <div id='calendar'></div>

</body>

</html>