<!DOCTYPE html>
<html>

<head>
  <meta charset='utf-8' />
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js" type="text/javascript"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js" type="text/javascript"></script>
  <script src='../dist/index.global.js'></script>
  <script>

    $(document).ready(function () {

      var initResources;
      var calendarEl = document.getElementById('calendar');

      var calendar = new FullCalendar.Calendar(calendarEl, {
        now: '2024-07-15',
        nowIndicator: true,
        initialDate: '2024-06-01',
        editable: true,
        aspectRatio: 1.8,
        //scrollTime: '00:00',
        headerToolbar: {
          left: 'today prev,next',
          center: 'title',
          right: 'resourceTimelineDay,resourceTimelineThreeDays,timeGridWeek,dayGridMonth'
        },
        initialView: 'resourceTimeline',
        slotLabelFormat: [
          { month: 'numeric', year: 'numeric' },
          { day: 'numeric' },
          { weekday: 'short' },
          { weekday: 'short' },
        ],
        slotLabelInterval: { days: 1 }, // ヘッダの日付を表示する単位
        // スロット単位設定
        slotDuration: { days: 1 },
        // 開始
        // 期間
        duration: { months: 3 },
        views: {
          resourceTimelineThreeDays: {
            type: 'resourceTimeline',
            duration: { days: 3 },
            buttonText: '3 days'
          }
        },
        resourceOrder: 'sortOrder',
        resourceAreaWidth: '500px',

        resources: [
          { id: '1', title: 'Auditorium A', occupancy: 40, subRoom: 'A1', sortOrder: 0 },
          { id: 'a', title: 'Auditorium A', occupancy: 40, subRoom: 'A1', sortOrder: 1 }, 
          
              { id: 'b', title: 'Auditorium B', occupancy: 40, subRoom: 'B1', eventColor: 'green', parentId: 'a', sortOrder: 2 },
              { id: 'c', title: 'Auditorium C', occupancy: 40, subRoom: 'C1', eventColor: 'orange', parentId: 'a', sortOrder: 3 },
              { id: 'd', title: 'Auditorium D', occupancy: 40, subRoom: 'D1', parentId: 'a', sortOrder: 4 },
              { id: 'd1', title: 'Room D1', occupancy: 10, subRoom: 'D1-A', parentId: 'd2', sortOrder: 5 },
            
          
          {id: 'd2', title: 'Room D2', occupancy: 10, subRoom: 'D1-B', sortOrder: 6},
              { id: 'e', title: 'Auditorium E', occupancy: 40, subRoom: 'E1', parentId: 'd2', sortOrder: 7 },
              { id: 'f', title: 'Auditorium F', occupancy: 40, subRoom: 'F1', eventColor: 'red', parentId: 'd2', sortOrder: 8 },
              { id: 'g', title: 'Auditorium G', occupancy: 40, subRoom: 'G1', parentId: 'd2', sortOrder: 9 },
              { id: 'h', title: 'Auditorium H', occupancy: 40, subRoom: 'H1', parentId: 'd2', sortOrder: 10 },
              { id: 'i', title: 'Auditorium I', occupancy: 40, subRoom: 'I1', parentId: 'd2', sortOrder: 11 },
              { id: 'j', title: 'Auditorium J', occupancy: 40, subRoom: 'J1', parentId: 'd2', sortOrder: 12 },
              { id: 'k', title: 'Auditorium K', occupancy: 40, subRoom: 'K1', parentId: 'd2', sortOrder: 13 },
              { id: 'l', title: 'Auditorium L', occupancy: 40, subRoom: 'L1', parentId: 'd2', sortOrder: 14 },
              { id: 'm', title: 'Auditorium M', occupancy: 40, subRoom: 'M1', parentId: 'd2', sortOrder: 15 },
          
          {id: 'n', title: 'Auditorium N', occupancy: 40, subRoom: 'N1', sortOrder: 16},
              { id: 'o', title: 'Auditorium O', occupancy: 40, subRoom: 'O1', parentId: 'n', sortOrder: 17 },
              { id: 'p', title: 'Auditorium P', occupancy: 40, subRoom: 'P1', parentId: 'n',sortOrder: 18 },
              { id: 'q', title: 'Auditorium Q', occupancy: 40, subRoom: 'Q1', parentId: 'n',sortOrder: 19 },
              { id: 'r', title: 'Auditorium R', occupancy: 40, subRoom: 'R1', parentId: 'n',sortOrder: 20 },
              { id: 's', title: 'Auditorium S', occupancy: 40, subRoom: 'S1', parentId: 'n',sortOrder: 21 },
              { id: 't', title: 'Auditorium T', occupancy: 40, subRoom: 'T1', parentId: 'n',sortOrder: 22 },
              { id: 'u', title: 'Auditorium U', occupancy: 40, subRoom: 'U1', parentId: 'n',sortOrder: 23 },
              { id: 'v', title: 'Auditorium V', occupancy: 40, subRoom: 'V1', parentId: 'n',sortOrder: 24 },
              { id: 'w', title: 'Auditorium W', occupancy: 40, subRoom: 'W1', parentId: 'n',sortOrder: 25 },
              { id: 'x', title: 'Auditorium X', occupancy: 40, subRoom: 'X1', parentId: 'n',sortOrder: 26 },
              { id: 'y', title: 'Auditorium Y', occupancy: 40, subRoom: 'Y1', parentId: 'n',sortOrder: 27 },
              { id: 'z', title: 'Auditorium Z', occupancy: 40, subRoom: 'Z1', parentId: 'n',sortOrder: 28 }
      ],

        resourceAreaColumns: [
          {
            headerContent: "header 1",
            field: "title",
            width: "200px"
          },
          {
            headerContent: "header 2",
            field: "occupancy",
            width: "100px"
          },
          {
            headerContent: "header 3",
            field: "subRoom",
            width: "100px"
          },
          {
            headerContent: "header 4",
            field: "sortOrder",
            width: "100px"
          }
        ],

        events: [
          { id: '1', resourceId: 'b', start: '2023-01-07T02:00:00', end: '2023-01-07T07:00:00', title: 'event 1' },
          { id: '2', resourceId: 'c', start: '2023-01-07T05:00:00', end: '2023-01-07T22:00:00', title: 'event 2' },
          { id: '3', resourceId: 'd', start: '2023-01-06', end: '2023-01-08', title: 'event 3' },
          { id: '4', resourceId: 'e', start: '2023-01-07T03:00:00', end: '2023-01-07T08:00:00', title: 'event 4' },
          { id: '5', resourceId: 'f', start: '2023-01-07T00:30:00', end: '2023-01-07T02:30:00', title: 'event 5' }
        ],
        datesSet: function() {
          console.log('test');
          calendar.setOption('duration', {month:7});
          //calendar.gotoDate('2024-08-01');
          //scrollToSpecificDate('2024-08-01');
        },
        viewDidMount: function (arg) {
          calendar.setOption('initialDate','2024-06-01');
          // calendar.gotoDate('2024-09-01');
          $('.fc-datagrid-header').css('min-width', '400px');
          $('.fc-datagrid-header').css('max-width', '400px');
          $('.fc-datagrid-body').css('min-width', '400px');
          $('.fc-datagrid-body').css('max-width', '400px');
          const table = $('.fc-datagrid-body tbody').first();
          const rows = table.find('tr');

          Array.from(rows).slice(1, 6).forEach(row => {
            $(row).attr('data-section','1');
          });

          Array.from(rows).slice(6, 15).forEach(row => {
            $(row).attr('data-section','2');
          });
          let sortableClasses = ['.sortable-row', '.sortable-row-1'];
          // sortableClasses.forEach(sortableClass => {
            let originalItem;
            let draggedGroup;
            let draggedItems;         
            $(".fc-datagrid-body tbody").sortable({

            // items: 'tr:not(:first-child)',
            items: 'tr',
            dropOnEmpty: false,
            //revert: true,

            placeholder: 'ui-state-highlight',

            // helper: 'original',
            //     // Store the group of rows to drag
            //     // draggedGroup = ui.data('group');
            //     // draggedItems = ui.closest('tbody').find(`tr[data-group="${draggedGroup}"]`);
            //     draggedGroup = ui.data('section');


            //     draggedItems = ui.closest('tbody').find(`tr[data-section="${draggedGroup}"]`);

            //     // Create a custom helper
            //     const helper = $('<div><ul></ul></div>');
            //     const tbody = helper.find('ul');
            //     // draggedItems.clone().appendTo(helper);
            //     // Adjust width of the helper columns to match the original table
            //     draggedItems.each(function (index, element) {
            //       const originalTds = $(element).children().eq(0);
            //       originalTds.each(function(index, ele) {
            //         $('<li>').append($(ele).text()).appendTo(tbody);
            //       });
            //       // const clonedTds = tbody.children().eq(index).children();
            //       // clonedTds.each(function (tdIndex, clonedTd) {
            //       //   $(clonedTd).width($(originalTds[tdIndex]).width());
            //       // });
            //     });

                
            //     return helper;
            //   },

            helper: function(e, tr) {
            //     draggedGroup = tr.data('section');
            //     draggedItems = tr.closest('tbody').find(`tr[data-section="${draggedGroup}"]`);

            //     var $originals = tr.children();
            //     var $helper = tr.clone();
            //     $.each(draggedItems, function(index, item) {
            //       var $helperCell = $(this).clone();
            //       $helperCell.children().each(function(index) {
            //           $(this).width($originals.eq(index).width());
            //       });
            //       $helper.append($helperCell);
            //     })
            //     // $helper.append();
            //     // $helper.children().each(function(index) {
            //     //     // Set helper cell sizes to match the original sizes
            //     //     $(this).width($originals.eq(index).width());
            //     // });
                 return tr.html();
            },

            start: function (G, ui) {
              draggedGroup = ui.item.data('section');
              draggedItems = ui.item.closest('tbody').find(`tr[data-section="${draggedGroup}"]`);
              console.log(draggedItems);
              //console.log(draggedItems);
              //draggedItems.addClass('dragging');
              var placeholder = ui.placeholder;

              placeholder.empty();
              placeholder.append(draggedItems);

              console.log($(placeholder)[0].childNodes)
              $.each($(placeholder)[0].childNodes, function (index, value) {
                 $(value).removeAttr('style');
                 console.log($(draggedItems).eq(index));
                //  $(value).children().each(function(index) {
                //     // Set helper cell sizes to match the original sizes
                //     $(this).width($(draggedItems).eq(index).width());
                //  });
              })
              

              ui.item.data('originalSection', ui.item.data('section'));
              ui.item.data('originalIndex', ui.item.index());
              // Hide the dragged rows initially
              //draggedItems.css('visibility', 'hidden');
            },

            sort: function (event, ui) {
              // let originalSection = ui.item.data('section');
              // let newSection = ui.placeholder.prev().data('section') || ui.placeholder.next().data('section');

              // if (!newSection) {
              //   newSection = ui.item.data('section');
              // }

              // if (originalSection !== newSection) {
              //   ui.placeholder.addClass('disabled');
              // } else {
                //console.log(ui.helper.html());
                // //draggedItems.css('visibility', 'visible');
                // ui.placeholder.html(ui.item.html());
                // ui.placeholder.removeClass('disabled');
                // // Show the dragged rows while sorting
               // ui.placeholder.html(ui.helper.html());
                // var $placeholder = ui.placeholder;
                // $placeholder.css({
                //     visibility: 'visible',
                //     height: ui.helper.outerHeight()
                // });
                // $placeholder.children().each(function(index) {
                //     $(this).width(ui.helper.children().eq(index).width());
                // });
                
              // }
            },
  
            stop: function (event, ui) {
              // After drag stop, enforce section rules
              let originalSection = ui.item.data('section');
              let originalIndex = ui.item.data('originalIndex');
              let newSection = ui.item.prev().data('section') || ui.item.next().data('section');

              if (!newSection) {
                newSection = ui.item.data('section');
              }

              if (originalSection !== newSection) {
                // Revert to the original position if moved to a different section
                let originalItem = $('.fc-datagrid-body tr').eq(originalIndex);
                if(originalIndex > ui.item.index()) {
                  let currentItem =  ui.item.detach();
                  originalItem.after(currentItem); // Move the item back to its original position
                } else if (originalIndex < ui.item.index()) {
                  let currentItem =  ui.item.detach();
                  originalItem.before(currentItem); // Move the item back to its original position
                }
              } else {
                //var sortedIDs = $(this).sortable("toArray", { attribute: "data-resource-id" });
                var sortedIDs = $(this).children('tr').map(function () {
                  return $(this).find('td[data-resource-id]').data('resource-id');
                }).get();
                // Update resource order in FullCalendar
                var sortedResources = sortedIDs.map(function (id) {
                  return calendar.getResourceById(id);
                });
                sortedResources.forEach(function (resource, index) {
                  resource.setExtendedProp('sortOrder', index);
                });
                //update resource
                //calendar.setOption('resources', sortedResources);
              }
              // Manually trigger a re-render of the resources
              // calendar.render();
            }
      
          });

        // });
          //$(".fc-datagrid-body tbody").disableSelection();

          // Add custom group header after rendering
          const tableHeader = calendarEl.querySelector('.fc-datagrid-header thead tr');
          const groupHeader = document.createElement('tr');
          $(groupHeader).css('height','49px');

          // Create a group header cell that spans 3 columns
          const groupHeaderCell1 = document.createElement('th');
          groupHeaderCell1.setAttribute('colspan', '1');
          groupHeaderCell1.className = 'fc-col-group-header';
          groupHeaderCell1.innerText = '';
          const groupHeaderCell2 = document.createElement('th');
          groupHeaderCell2.setAttribute('colspan', '2');
          groupHeaderCell2.className = 'fc-col-group-header';
          groupHeaderCell2.innerText = 'Group Header';
          const groupHeaderCell3 = document.createElement('th');
          groupHeaderCell3.setAttribute('colspan', '1');
          groupHeaderCell3.className = 'fc-col-group-header';
          groupHeaderCell3.innerText = '';
          groupHeader.appendChild(groupHeaderCell1);
          groupHeader.appendChild(groupHeaderCell2);
          groupHeader.appendChild(groupHeaderCell3);

          // Insert the group header row before the column headers
          tableHeader.parentNode.insertBefore(groupHeader, tableHeader);
        }
        
        //  eventContent: function (arg) {
        //  resourceAreaHeaderContent: function (arg) {
        //   return "room";
        //  },

      });

      calendar.render();

      
      $('#gotoDate').on('click', function () {
        scrollToSpecificDate(new Date());
      })
      initResources = calendar.getResources();

      function scrollToSpecificDate(date) {
        var date = new Date();
        var timeGrid = $(`td .fc-timeline-slot[data-date="2024-07-15"]`)[0];
      
        console.log(timeGrid);
        timeGrid.scrollIntoView({inline: "center"});
      }

      $("#resourceFilter").on('keyup', function (event) {
        if (event.keyCode == 13) {

          var filterValue = this.value.toLowerCase();

          // Filter resources
          var filteredResources = initResources.filter(function (resource) {
            return resource.title.toLowerCase().includes(filterValue);
          });

          // Set filtered resources to the calendar
          console.log(filteredResources);
          // calendar.refetchResources = function () {
          //   return filteredResources;
          // };

          // // Re-render the calendar with the filtered resources
          // calendar.render();

          // Update the calendar with the filtered resources
          calendar.batchRendering(function () {
            calendar.getResources().forEach(function (resource) {
              resource.remove();
            });
            filteredResources.forEach(function (resource, index) {
              // when resource is child, add it's parent to calendar
              if (resource._resource.parentId != null && resource._resource.parentId != '') {
                // if parent not exist in calendar, add it
                if (calendar.getResourceById(resource._resource.parentId) == null) {
                  calendar.addResource(initResources.filter(function (r) {
                    return r.id == resource._resource.parentId
                  })[0]);
                }
              } else {
                  // when resource is parent, add child resources to calendar
                  initResources.filter(function (r) {
                    return r._resource.parentId == resource.id
                  }).forEach(function(resource, index) {
                    // if child not exist in calendar, add it
                    if(calendar.getResourceById(resource.id) == null) {
                      calendar.addResource(resource);
                    }
                  })
              }
              calendar.addResource(resource);
            });
          });
        }
      });
    });


  </script>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, Helvetica Neue, Helvetica, sans-serif;
      font-size: 14px;
    }

    #calendar {
      max-width: 1100px;
      margin: 50px auto;
    }

    .ui-state-highlight {
      background-color: #ddd; /* Background color for the placeholder */
      border: 1px dashed #aaa; /* Dashed border to distinguish placeholder */
    }

    .disabled { display: none;} /* Disabled effect */

    .fc-col-group-header {
      text-align: center;
      font-weight: bold;
      background-color: #fff;
      border-bottom: none;
    }
    .fc-col-group {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    /* .fc-datagrid-cell-resizer {
      pointer-events: none;
      cursor: default;
    } */
  </style>
</head>

<body>

  <input type="text" id="resourceFilter" placeholder="Filter resources..." />
  <input type="button" id="gotoDate" value="Go to date" />
  <div id='calendar'></div>

</body>

</html>